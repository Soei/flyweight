"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const f=require("@soei/util"),o=require("vue");const T=(e,t)=>{const l=e.__vccOpts||e;for(const[h,i]of t)l[h]=i;return l};let k=e=>e==null||e==null,H=/(\d+|[+\-\*/]|%)/g,b={"+":(e,t)=>e+t,"-":(e,t)=>e-t,"*":(e,t)=>e*t,"/":(e,t)=>e/t,"%":(e,t,l)=>parseFloat(e)/100*l},v=(e,t)=>{let l;if(l=f.runer("match",e,H)){let h=l.length,i,s=0,r,n=[];for(;h--;)s=l.shift(),s in b?(i&&n.push(i),s==="%"&&(n.length=2),r=s):+s&&n.push(+s),n.length==2&&(n.push(t),i=b[r].apply(null,n),n.length=0);+i||(i=+n.pop()),e=i>>0}return e},N=(...e)=>{console.info("::::FLYWEIGHT",...e)};const S={name:"Flyweight",props:{flys:{type:Array,default:()=>[]},width:{type:Number,default:0},height:{type:Number,default:100},offset:{type:Array,default:()=>[0,0]},lazy:{type:Number,default:100},view:{type:Object,default:()=>null},index:{type:Number,default:0},top:{type:Number,default:!1},left:{type:Number,default:!1},auto:{type:[Boolean,String],default:!1},space:{type:Object,default:()=>null}},computed:{flyweight(){return this.$refs.flyweight}},data(){return{flyweights:[],actice:!1,Height:null,column:1,row:1,fwheight:10,count:0,task:[],realW:0,realH:0}},watch:{flys(e){this.count=e.length,this.re();let t=this.task.shift();t&&this.$nextTick(()=>{this.setview(t)})},view:{handler(e){this.setview(e)},immediate:!0},index(e){this.setindex(e)},top(e){this.flyweight.scrollTop=e},left(e){this.flyweight.scrollLeft=e}},mounted(){this.flyweights=[],this.$set||(this.$set=(e,t,l)=>{e[t]=l}),this.setindex(this.index);try{new ResizeObserver(()=>{this.re(),this.$emit("resize")}).observe(this.flyweight)}catch(e){N(e)}},methods:{trigger(e,t){this.lazyrun(()=>{f.isArray(e)||(e=[[e,t]]),f.each(e,(l,h)=>{this.$emit(h[0],k(h[1])?!0:h[1])})})},cheackflys(e){if(!this.flys.length)return e&&this.task.push(e),!0},setview(e){f.runer([this.cheackflys,t=>{t=t||{};let l=t.index||f.each(this.flys,(h,i,s,r)=>{if(i[s]==r)return h},t.picker,t.id);k(l)||this.setindex(l)}],this,e)},setindex(e){f.runer([this.cheackflys,({index:t})=>{this.$nextTick(()=>{let l=t/this.column>>0,h=this.fwheight;(this.flyweight.scrollTop/h>>0)+this.row-l-1>0||(this.flyweight.scrollTop=l*h,this.scroll())})}],this,{index:e})},lazyrun(e,t){clearTimeout(this.time),this.time=setTimeout(()=>{f.runer(e)},t||this.lazy)},run(e){let t=f.picker(e.target,"scrollTop=>top");f.each(this.flyweights,(l,h,i,s,r,n,a,u)=>{if(i=l/r>>0,a=i+s*(+(i<n%s)+(n/s>>0)),u=a*r+l%r,u>=this.count){this.trigger("onend");return}h.index=a,h.top=a*this.fwheight,h.data=this.flys[u]},null,this.row,this.column,t.top/this.fwheight>>0)},scroll(e){this.run(e||{target:this.flyweight})},re(){let e=this.count||this.flys.length,t=this.flyweights;if(!e)return t.length=e;this.count=e;let l=this.flyweight,h=f.picker(l,"clientHeight=>height,clientWidth=>width");this.$nextTick(()=>{let i=this.auto===!0,[s,r]=this.offset,n=h.width,a=h.height,u=(v(this.width,n)||n)+s,g=v(this.height,a)+r;this.realW=u-s,this.realH=g-r;let c=n/u>>0||1,y=a/g>>0;this.row=y+2,this.column=c,this.fwheight=g;let x=n%u/(c-1*+!i)>>0;i&&(u=this.realW=(n/c>>0)-s,x=s),this.Height=Math.ceil(e/c)*g;let w=Math.min(e,c*this.row),p=w-1,d,_;for(;w-- >0;)d=p-w,_=this.flys[d],l=t[d],y=d/c>>0,this.$set(t,d,{data:_,top:y*g,left:d%c*(u+x),index:y});t.length=p+1;let m=[];a/g>p&&m.push(["onend"]),this.scroll(),m.push(["update:space",{row:(p/c>>0)+1,column:c}]),this.trigger(m)})}}},B=["data"];function F(e,t,l,h,i,s){return o.openBlock(),o.createElementBlock("div",{ref:"flyweight",class:o.normalizeClass(["flyweight",{"flyweight-active":i.actice}]),style:o.normalizeStyle({"--width":i.realW+"px","--height":i.realH+"px"}),onScroll:t[0]||(t[0]=(...r)=>s.scroll&&s.scroll(...r))},[o.createElementVNode("div",{class:"flyweight-all",style:o.normalizeStyle({"--flyweight-height":i.Height+"px"})},[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(i.flyweights,(r,n)=>(o.openBlock(),o.createElementBlock("div",{key:n,data:r.top,style:o.normalizeStyle({top:r.top+"px",left:r.left+"px"})},[o.renderSlot(e.$slots,"default",{data:r.data,index:r.index},void 0,!0)],12,B))),128))],4),i.flyweights.length?o.renderSlot(e.$slots,"end",{key:0},void 0,!0):o.createCommentVNode("",!0)],38)}const z=T(S,[["render",F],["__scopeId","data-v-1342d2cb"]]),O=[z],$={install(e){O.forEach(t=>{e.component("s-"+t.name.toLowerCase(),t)})}};exports.Flyweight=z;exports.default=$;
